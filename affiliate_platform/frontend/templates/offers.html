<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û—Ñ—Ñ–µ—Ä—ã - Affiliate Bridge</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <a href="/" class="navbar-brand">Affiliate Bridge</a>
            <ul class="navbar-nav">
                <li><a href="/">–ì–ª–∞–≤–Ω–∞—è</a></li>
                <li><a href="/offers">–û—Ñ—Ñ–µ—Ä—ã</a></li>
                <li><a href="/dashboard" id="dashboardLink">–ö–∞–±–∏–Ω–µ—Ç</a></li>
                <li><a href="/login" id="loginLink" class="btn btn-primary">–í–æ–π—Ç–∏</a></li>
            </ul>
        </div>
    </nav>

    <div class="container" style="padding: 3rem 0;">
        <h1 class="mb-4">–î–æ—Å—Ç—É–ø–Ω—ã–µ –æ—Ñ—Ñ–µ—Ä—ã</h1>

        <!-- –§–∏–ª—å—Ç—Ä—ã -->
        <div style="background: white; padding: 1.5rem; border-radius: 1rem; box-shadow: var(--shadow); margin-bottom: 2rem;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                <div>
                    <label class="form-label">–ü–æ–∏—Å–∫</label>
                    <input type="text" class="form-input" id="searchInput" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –æ—Ñ—Ñ–µ—Ä–∞...">
                </div>
                <div>
                    <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                    <select class="form-select" id="categoryFilter">
                        <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                    </select>
                </div>
                <div>
                    <label class="form-label">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</label>
                    <select class="form-select" id="sortFilter">
                        <option value="newest">–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ</option>
                        <option value="price_high">–¶–µ–Ω–∞: –ø–æ —É–±—ã–≤–∞–Ω–∏—é</option>
                        <option value="price_low">–¶–µ–Ω–∞: –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é</option>
                        <option value="commission">–ö–æ–º–∏—Å—Å–∏—è: –ø–æ —É–±—ã–≤–∞–Ω–∏—é</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ –æ—Ñ—Ñ–µ—Ä–æ–≤ -->
        <div class="offers-grid" id="offersContainer">
            <p>–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ñ—Ñ–µ—Ä–æ–≤...</p>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/auth.js') }}"></script>
    <script>
        let allOffers = [];
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        if (token && user.id) {
            document.getElementById('dashboardLink').style.display = 'block';
            document.getElementById('loginLink').style.display = 'none';
        } else {
            document.getElementById('dashboardLink').style.display = 'none';
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ñ—Ñ–µ—Ä–æ–≤
        async function loadOffers() {
            try {
                const response = await fetch('/api/offers');
                allOffers = await response.json();

                // –ü–æ–ª—É—á–µ–Ω–∏–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
                const categories = [...new Set(allOffers.map(o => o.category).filter(Boolean))];
                const categoryFilter = document.getElementById('categoryFilter');
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    categoryFilter.appendChild(option);
                });

                displayOffers(allOffers);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ñ—Ñ–µ—Ä–æ–≤:', error);
                document.getElementById('offersContainer').innerHTML =
                    '<p class="text-center">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ñ—Ñ–µ—Ä–æ–≤</p>';
            }
        }

        function displayOffers(offers) {
            const container = document.getElementById('offersContainer');

            if (offers.length === 0) {
                container.innerHTML = '<p class="text-center">–û—Ñ—Ñ–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                return;
            }

            container.innerHTML = offers.map(offer => `
                <div class="offer-card">
                    <div class="offer-image"></div>
                    <div class="offer-content">
                        <div class="offer-title">${offer.title}</div>
                        <p class="offer-description">${offer.description || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}</p>
                        ${offer.category ? `<p style="color: var(--text-secondary); font-size: 0.875rem;">üìÅ ${offer.category}</p>` : ''}
                        <div class="offer-details">
                            <div class="offer-price">${formatPrice(offer.price)} —Å—É–º</div>
                            <div class="offer-commission">+${offer.commission_percent}%</div>
                        </div>
                        <p style="color: var(--success-color); font-weight: 600; margin-bottom: 1rem;">
                            –í–∞—à –∑–∞—Ä–∞–±–æ—Ç–æ–∫: ${formatPrice(offer.partner_commission)} —Å—É–º
                        </p>
                        ${user.user_type === 'partner' ?
                            `<button class="btn btn-primary" style="width: 100%;" onclick="getAffiliateLink(${offer.id})">
                                –ü–æ–ª—É—á–∏—Ç—å —Å—Å—ã–ª–∫—É
                            </button>` :
                            `<a href="/register?type=partner" class="btn btn-primary" style="width: 100%;">
                                –°—Ç–∞—Ç—å –ø–∞—Ä—Ç–Ω—ë—Ä–æ–º
                            </a>`
                        }
                    </div>
                </div>
            `).join('');
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–æ–π —Å—Å—ã–ª–∫–∏
        async function getAffiliateLink(offerId) {
            if (!token) {
                window.location.href = '/login';
                return;
            }

            try {
                const response = await fetch('/api/affiliate-links', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ offer_id: offerId })
                });

                const result = await response.json();

                if (response.ok) {
                    const link = result.link.tracking_url;
                    alert(`–í–∞—à–∞ –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∞—è —Å—Å—ã–ª–∫–∞:\n\n${link}\n\n–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!`);
                    navigator.clipboard.writeText(link);
                } else {
                    alert(result.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å—Å—ã–ª–∫–∏');
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
            }
        }

        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ –ø–æ–∏—Å–∫
        document.getElementById('searchInput').addEventListener('input', filterOffers);
        document.getElementById('categoryFilter').addEventListener('change', filterOffers);
        document.getElementById('sortFilter').addEventListener('change', filterOffers);

        function filterOffers() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const category = document.getElementById('categoryFilter').value;
            const sortBy = document.getElementById('sortFilter').value;

            let filtered = allOffers.filter(offer => {
                const matchesSearch = offer.title.toLowerCase().includes(searchTerm) ||
                                    (offer.description && offer.description.toLowerCase().includes(searchTerm));
                const matchesCategory = !category || offer.category === category;

                return matchesSearch && matchesCategory;
            });

            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
            switch (sortBy) {
                case 'price_high':
                    filtered.sort((a, b) => b.price - a.price);
                    break;
                case 'price_low':
                    filtered.sort((a, b) => a.price - b.price);
                    break;
                case 'commission':
                    filtered.sort((a, b) => b.commission_percent - a.commission_percent);
                    break;
                default: // newest
                    filtered.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            }

            displayOffers(filtered);
        }

        function formatPrice(price) {
            return new Intl.NumberFormat('ru-RU').format(price);
        }

        loadOffers();
    </script>
</body>
</html>
